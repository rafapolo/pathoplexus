# CLAUDE.md

## What This Repository Is

Pathoplexus is a specialized genomic database for viruses of public health importance. This repository is an **overlay** over the [Loculus](https://github.com/loculus-project/loculus) monorepo - it contains only Pathoplexus-specific customizations that are layered on top of the base Loculus codebase.

## How The Overlay Architecture Works

The key insight is that this repo doesn't contain a complete application - it's a set of customizations applied to Loculus:

1. **Version Pinning**: `pathoplexus_app/values.yaml` specifies exactly which Loculus commit to use
2. **Sync Process**: `./sync.sh` fetches that specific Loculus version and copies it to `monorepo/` (which is gitignored)
3. **Overlay**: Pathoplexus-specific files in `monorepo/` override the corresponding Loculus files
4. **Scope Control**: `monorepo/.gitignore` determines which files are Pathoplexus-specific vs inherited from Loculus

## Repository Structure

- **`monorepo/`**: Complete Loculus codebase with Pathoplexus overlays (see detailed structure below)
- **`loculus_values/`**: Configuration files that define how Pathoplexus differs from base Loculus
- **`pathoplexus_app/`**: Kubernetes deployment config and Loculus version reference
- **`data-integrity-tests/`**: Snakemake workflows for regression testing across environments
- **`scripts/`**: Database utility scripts

## Monorepo Structure

The `monorepo/` directory contains the complete Loculus application stack with Pathoplexus customizations:

### Core Services
- **`backend/`**: Spring Boot backend (Kotlin) - sequence submission, user management, data processing
- **`website/`**: Astro/React frontend - user interface, search, submission forms
- **`ingest/`**: Snakemake pipeline for ingesting external data (NCBI, etc.)
- **`preprocessing/`**: Sequence processing pipelines (Nextclade integration)
- **`ena-submission/`**: Pipeline for submitting sequences to European Nucleotide Archive

### Infrastructure & Deployment
- **`kubernetes/`**: Helm charts and deployment templates
- **`cli/`**: Python CLI tool for programmatic access
- **`keycloak/`**: Authentication UI customizations
- **`integration-tests/`**: Playwright end-to-end tests
- **`docs/`**: Astro-based documentation site

### Key Files in Monorepo
- **`monorepo/.gitignore`**: Lists all files inherited from Loculus (auto-generated by sync.sh)
- **`monorepo/AGENTS.md`**: Instructions for AI agents working on Loculus code
- Files NOT in `.gitignore` are Pathoplexus-specific customizations

## Development Workflow

### Initial Setup
```bash
# Sync with the pinned Loculus version (required first step)
./sync.sh

# Install dependencies and start local development
cd monorepo/website && npm ci && npm run dev
```

### Key Development Commands
```bash
# Sync with latest pinned Loculus version
./sync.sh

# Clean up to see only Pathoplexus-specific files
git clean -fX monorepo

# Run data integrity tests
cd data-integrity-tests && snakemake -c1

# Backend development
cd monorepo/backend && ./start_dev.sh

# Run integration tests  
cd monorepo/integration-tests && npm test

# Build and test CLI
cd monorepo/cli && uv run python -m loculus_cli --help
```

### Working with the Overlay System

**Understanding what's Pathoplexus vs Loculus:**
- Files listed in `monorepo/.gitignore` are inherited from Loculus
- Files NOT in `.gitignore` are Pathoplexus customizations
- Use `git status` in `monorepo/` to see tracked (Pathoplexus-specific) files

**Adding new customizations:**
1. Run `./sync.sh` to get latest Loculus base
2. Modify files in `monorepo/` - they automatically become Pathoplexus customizations
3. The sync script will update `.gitignore` to exclude new Loculus files

**Updating Loculus version:**
1. Change `loculusVersion` in `pathoplexus_app/values.yaml`
2. Run `./sync.sh` to pull new version
3. Test your customizations still work with the new base

## Configuration System

### Core Configuration Files

**Main Config**: `loculus_values/values.yaml` contains the primary Pathoplexus configuration:
- **Organisms**: Supported pathogens (cchf, west-nile, ebola variants, mpox, rsv-a/b, hmpv)
- **Branding**: Site name ("Pathoplexus"), accession prefix ("PPD_")  
- **Authentication**: ORCID integration, SMTP settings, email verification
- **Features**: Data use terms, sequence flagging, lineage systems
- **Preprocessing**: Pipeline timeouts and configurations
- **UI Customizations**: Banner messages, navigation, styling

**Environment Overrides**: `loculus_values/environment_specific_values/` contains deployment-specific settings:
- `demo.yaml` - Demo instance configuration
- `staging.yaml` - Staging environment settings  
- `production.yaml` - Production deployment config
- `main.yaml` - Main/development settings

### Key Configuration Concepts

**Organism Schema**: Each pathogen has its own metadata schema, reference genomes, and processing pipelines defined in `values.yaml`.

**Preprocessing Pipelines**: Organism-specific processing using Nextclade for sequence QC, alignment, and clade assignment.

**Lineage Systems**: External YAML files defining hierarchical classification systems for each organism.

**Data Use Terms**: Integration with external terms of use for open vs restricted data access.

## Deployment & Infrastructure

### Deployment Flow
Pathoplexus uses a GitOps deployment model:
1. **Source Repository** (this repo): Contains code, configurations, and Docker image definitions
2. **Deployment Repository** (`pathoplexus/loculus_deployments`): References specific commit SHAs from this repo
3. **ArgoCD**: Watches the deployment repo and automatically deploys changes to Kubernetes clusters
4. **Kubernetes**: Runs the full application stack using Helm charts from `monorepo/kubernetes/`

### Infrastructure Components
- **Kubernetes Cluster**: Hosts all services (backend, frontend, databases, processing pipelines)
- **PostgreSQL**: Main application database and Keycloak authentication database
- **MinIO/S3**: Object storage for sequence files and attachments
- **LAPIS/SILO**: High-performance sequence search and aggregation API
- **Keycloak**: Authentication and user management

### Database Management
- **Production Database**: Primary data store for released sequences
- **Staging Database**: Testing environment, can be cloned from production using scripts in `scripts/db-clone/`
- **Schema Migrations**: Handled by Flyway for both main database and ENA submission database

## Testing Infrastructure

### Data Integrity Testing
- **Location**: `data-integrity-tests/regression-testing/`
- **Purpose**: Validates data consistency between production and staging environments
- **Technology**: Snakemake workflows that compare sequence data and metadata
- **Coverage**: Tests all supported organisms (cchf, west-nile, ebola variants, mpox, rsv-a/b, hmpv)
- **Execution**: `snakemake -c1` from the data-integrity-tests directory

### Integration Testing  
- **Location**: `monorepo/integration-tests/`
- **Technology**: Playwright for end-to-end browser testing
- **Coverage**: Full user workflows including submission, review, search, and authentication
- **Test Data**: Synthetic sequences and metadata for each supported organism

### Unit Testing
- **Backend**: Kotlin/JUnit tests for business logic and API endpoints
- **Frontend**: Vitest for React components and utility functions
- **CLI**: Python pytest for command-line interface testing
- **Preprocessing**: Python tests for sequence processing pipelines

## Development Best Practices

### Understanding the Codebase
1. **Always run `./sync.sh` first** - The monorepo is populated from Loculus, not committed to git
2. **Check `monorepo/.gitignore`** - Shows which files are inherited vs customized
3. **Read `monorepo/AGENTS.md`** - Contains AI agent instructions for the Loculus codebase
4. **Component-specific AGENTS.md files** - Several subdirectories have their own agent instructions

### Making Changes
1. **Understand the overlay** - Determine if you're modifying Loculus base code or Pathoplexus customizations
2. **Test across environments** - Changes may affect multiple deployment targets
3. **Run appropriate tests** - Use data integrity tests for data-affecting changes
4. **Follow Loculus patterns** - When extending functionality, follow existing Loculus conventions

### Debugging Issues
- **Local development**: Use `./sync.sh` + `cd monorepo/website && npm run dev`
- **Database issues**: Check `scripts/db-clone/` for database debugging tools
- **Pipeline failures**: Examine Snakemake logs in `data-integrity-tests/`
- **Integration test failures**: Review Playwright reports in `monorepo/integration-tests/`

### Version Management
- **Current Loculus version**: Check `pathoplexus_app/values.yaml` for the pinned commit
- **Updating base**: Change `loculusVersion` in values.yaml, then run `./sync.sh`
- **Deployment tracking**: The separate deployment repo manages which commits are live

This overlay architecture allows Pathoplexus to stay current with Loculus development while maintaining its specialized customizations for public health pathogen genomics.
